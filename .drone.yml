kind: pipeline
type: docker
name: default

clone:
  disable: true

steps:
  - name: clone
    image: alpine/git
    environment:
      SSH_PRIVATE_KEY:
        from_secret: SSH_PRIVATE_KEY
    commands:
      - apk add --no-cache openssh
      - mkdir -p ~/.ssh
      # write Ed25519 key
      - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_ed25519
      - chmod 600 ~/.ssh/id_ed25519
      # add Gitea host key
      - ssh-keyscan gitea >> ~/.ssh/known_hosts
      # force Git to use Ed25519 key
      - GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" git clone ssh://git@gitea:22/ben/hello-python.git .
    network_mode: vm-dev-net

  - name: test
    image: python:3.12-slim
    commands:
      - pip install -r requirements.txt
      - PYTHONPATH=. pytest
    network_mode: vm-dev-net