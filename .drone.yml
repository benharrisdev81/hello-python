kind: pipeline
type: docker
name: default

clone:
  disable: true

steps:
  - name: clone
    image: alpine/git
    environment:
      SSH_PRIVATE_KEY:
        from_secret: SSH_PRIVATE_KEY
    commands:
      - apk add --no-cache openssh
      - mkdir -p ~/.ssh
      - printf "%s\n" "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
      - chmod 600 ~/.ssh/id_rsa
      - ssh-keyscan gitea >> ~/.ssh/known_hosts
      - GIT_SSH_COMMAND="ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes" git clone ssh://git@gitea:22/ben/hello-python.git .
    network_mode: vm-dev-net

  - name: test
    image: python:3.12-slim
    commands:
      - pip install -r requirements.txt
      - pytest
    network_mode: vm-dev-net